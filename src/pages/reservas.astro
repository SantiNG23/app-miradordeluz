---
import Layout from "../layouts/Layout.astro";
import CabanaCarousel from "../components/react/CabanaCarousel";
import ReservaSummary from "../components/react/ReservaSummary";
import AmenityIcon from "../components/react/AmenityIcon";
import AmenitiesModal from "../components/react/AmenitiesModal";
import { getCabanaById } from "../constants/cabanas";

// Leer parámetro de consulta (si viene desde los botones de las cabañas)
const url = new URL(Astro.request.url);
const cabanaId = url.searchParams.get("cabana") ?? "";

// Mock data para desarrollo: cabaña + rangos de precio
const MOCK_CABANA = {
  id: "1",
  nombre: "Los Pinos",
  capacidad: 4,
  caracteristicas: [
    "Pileta",
    "Cochera techada",
    "Aire acondicionado",
    "TV LED",
  ],
  precio_base: 85000,
  descripcion:
    "Cabaña con vistas al jardín.\nCálida, funcional y con todas las comodidades.",
  images: [
    "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1600",
    "https://images.unsplash.com/photo-1542718610-a1d656d1884c?w=1600",
  ],
};

// Rangos de precios mockeados para simular temporadas
const MOCK_PRICE_RANGES = [
  {
    fecha_inicio: "2025-01-01",
    fecha_fin: "2025-03-31",
    precio_por_noche: 85000,
  },
  {
    fecha_inicio: "2025-04-01",
    fecha_fin: "2025-12-14",
    precio_por_noche: 95000,
  },
  {
    fecha_inicio: "2025-12-15",
    fecha_fin: "2026-01-10",
    precio_por_noche: 120000,
  },
];

// Si existe una cabaña real, la usamos; si no, caemos al mock (id=1)
const cabana =
  cabanaId && cabanaId === String(MOCK_CABANA.id)
    ? MOCK_CABANA
    : cabanaId
      ? getCabanaById(cabanaId)
      : MOCK_CABANA;

// Normalizar features para evitar errores de tipos entre el mock y el type importado
const cabanaFeatures = (cabana && (cabana as any).caracteristicas) ?? null;

const pageTitle = cabana ? `Reservar - ${cabana.nombre}` : "Reservas";
const images = cabana?.images ?? MOCK_CABANA.images;
---

<Layout
  title={pageTitle}
  description="Formulario de reserva y detalle de la cabaña"
  image="/videos/LagoSanRoque.mp4"
>
  <main class="max-w-7xl mx-auto px-4 md:px-8 py-12">
    <!-- Breadcrumb + title (fuera de la columnas para no alterar layout) -->
    <div class="mb-6">
      <a
        class="inline-flex items-center text-sm text-gray-600"
        href="/"
        aria-label="Volver al inicio"
      >
        ← Volver al inicio
      </a>
      {
        cabana && (
          <h1 class="text-3xl font-extrabold text-[#1E1E1E] mt-3">
            {cabana.nombre}
          </h1>
        )
      }
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start">
      <!-- Columna izquierda: imagenes, descripcion, amenidades (3fr of 4) -->
      <section class="space-y-8 lg:col-span-2">
        <!-- title moved above to avoid affecting column layout -->

        <!-- Carrusel de imágenes -->
        <div>
          <CabanaCarousel
            client:visible
            images={images}
            alt={`Imágenes cabaña ${cabana?.nombre ?? cabanaId ?? "default"}`}
          />
        </div>

        <!-- Descripción -->
        <div class="bg-white rounded-2xl p-6 shadow">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Descripción</h2>
          <div class="text-gray-600 space-y-2">
            {
              cabana ? (
                <>
                  {cabana.descripcion.split("\n").map((line: string) => (
                    <p class="relative pl-6">
                      <span class="absolute left-0 top-2 w-2 h-2 bg-amber-300 rounded-full" />
                      {line}
                    </p>
                  ))}
                </>
              ) : (
                <ul class="list-disc pl-5 space-y-2 text-gray-600">
                  <li>Confort esencial para una escapada tropical</li>
                  <li>
                    Descansá en una habitación cómoda y funcional, con diseño
                    relajado
                  </li>
                  <li>Vista al jardín</li>
                  <li>Hasta 2 adultos</li>
                  <li>Cama Queen</li>
                  <li>Aire acondicionado, Wi-Fi, TV LED</li>
                </ul>
              )
            }
          </div>
        </div>

        <!-- Amenidades -->
        <div class="bg-white rounded-2xl p-6 shadow">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">
            Amenidades que redefinen el confort
          </h2>
          <div
            class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-10 justify-items-center py-8"
          >
            {
              cabanaFeatures ? (
                <>
                  {cabanaFeatures.map((amenidad: string) => (
                    <div class="flex flex-col items-center gap-3 text-center">
                      <div class="w-14 h-14 md:w-16 md:h-16 rounded-full flex items-center justify-center bg-stone-100 text-stone-700">
                        <AmenityIcon
                          client:visible
                          amenity={amenidad}
                          class="w-8 h-8"
                        />
                      </div>
                      <div class="font-montserrat text-sm md:text-base font-medium text-[#1E1E1E] max-w-[12rem] leading-snug">
                        {amenidad}
                      </div>
                    </div>
                  ))}
                  <div class="flex flex-col items-center gap-3 text-center">
                    <div class="w-14 h-14 md:w-16 md:h-16 rounded-full flex items-center justify-center bg-stone-100 text-stone-700">
                      <AmenityIcon
                        client:visible
                        amenity="WiFi"
                        class="w-8 h-8"
                      />
                    </div>
                    <div class="font-montserrat text-sm md:text-base font-medium text-[#1E1E1E]">
                      WiFi
                    </div>
                  </div>
                  <AmenitiesModal
                    client:visible
                    amenities={cabanaFeatures}
                    cabaName={cabana?.nombre}
                  />
                </>
              ) : (
                <>
                  <div class="flex flex-col items-center gap-3 text-center">
                    <div class="w-14 h-14 md:w-16 md:h-16 rounded-full flex items-center justify-center bg-stone-100 text-stone-700">
                      <AmenityIcon
                        client:visible
                        amenity={"WiFi"}
                        class="w-8 h-8"
                      />
                    </div>
                    <div class="font-montserrat text-sm md:text-base font-medium text-[#1E1E1E] truncate whitespace-nowrap max-w-[8rem] md:max-w-[9rem]">
                      WiFi gratuito
                    </div>
                  </div>
                  <div class="flex flex-col items-center gap-3 text-center">
                    <div class="w-14 h-14 md:w-16 md:h-16 rounded-full flex items-center justify-center bg-stone-100 text-stone-700">
                      <svg
                        class="w-8 h-8"
                        viewBox="0 0 24 24"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                        aria-hidden
                      >
                        <rect
                          x="2"
                          y="7"
                          width="20"
                          height="10"
                          rx="2"
                          stroke="currentColor"
                          stroke-width="2"
                        />
                      </svg>
                    </div>
                    <div class="font-montserrat text-sm md:text-base font-medium text-[#1E1E1E] truncate whitespace-nowrap max-w-[8rem] md:max-w-[9rem]">
                      Estacionamiento
                    </div>
                  </div>
                  <div class="flex flex-col items-center gap-3 text-center">
                    <div class="w-14 h-14 md:w-16 md:h-16 rounded-full flex items-center justify-center bg-stone-100 text-stone-700">
                      <svg
                        class="w-8 h-8"
                        viewBox="0 0 24 24"
                        fill="none"
                        xmlns="http://www.w3.org/2000/svg"
                        aria-hidden
                      >
                        <path
                          d="M7 11h10M5 15h14"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                      </svg>
                    </div>
                    <div class="font-montserrat text-sm md:text-base font-medium text-[#1E1E1E] truncate whitespace-nowrap max-w-[8rem] md:max-w-[9rem]">
                      Room Service
                    </div>
                  </div>
                </>
              )
            }
          </div>
        </div>
      </section>

      <!-- Columna derecha: panel de reserva (1fr) -->
      <aside class="sticky top-24 space-y-6 lg:col-span-1">
        <div class="mb-6">
          <ReservaSummary
            client:visible
            cabana={(cabana as any) ?? null}
            priceRanges={MOCK_PRICE_RANGES}
          />
        </div>

        <!-- Asesoría -->
        <div class="bg-white rounded-2xl p-6 shadow">
          <h3 class="text-lg font-bold text-gray-900 mb-2">
            ¿Necesitás ayuda?
          </h3>
          <p class="text-sm text-gray-600 mb-4">
            Nuestro equipo de concierge está disponible 24/7 para ayudarte a
            planificar la estadía perfecta.
          </p>
          <a
            class="w-full inline-block text-center border border-emerald-600 text-emerald-600 py-2 rounded-lg font-medium"
            href="https://wa.me/?text=Hola%20quiero%20asesoramiento%20sobre%20reservas%20en%20Mirador%20de%20Luz"
            target="_blank"
            rel="noopener noreferrer"
          >
            Contactar por WhatsApp
          </a>
        </div>
      </aside>
    </div>
  </main>
</Layout>
